<!-- templates/forum/post.html -->
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('forum') }}">Forum</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('forum_category', category_id=thread.category_id) }}">{{ thread.category.name }}</a></li>
            <li class="breadcrumb-item active">{{ thread.title }}</li>
        </ol>
    </nav>

    <!-- Thread Header -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ thread.title }}</h4>
                <div class="text-muted">
                    <small>Started {{ thread.created_at|time_ago }}</small>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Original Post -->
            {% if posts and posts|length > 0 %}
            <div class="post original-post mb-4">
                <div class="d-flex">
                    <div class="user-info text-center me-3" style="width: 120px;">
                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 60px; height: 60px; font-size: 1.5rem;">
                            {{ posts[0].author.username[0]|upper if posts[0].author else 'U' }}
                        </div>
                        <div class="user-details">
                            <strong class="d-block">{{ posts[0].author.username if posts[0].author else 'Unknown User' }}</strong>
                            <small class="text-muted">{{ posts[0].author.profession if posts[0].author and posts[0].author.profession else 'Member' }}</small>
                        </div>
                    </div>
                    <div class="post-content flex-grow-1">
                        <div class="post-meta mb-2">
                            <small class="text-muted">Posted {{ posts[0].created_at|time_ago }}</small>
                        </div>
                        <div class="post-body">
                            {{ posts[0].content|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Replies -->
            <h5 class="mb-3">
                Replies 
                <span class="badge bg-secondary">{{ posts|length - 1 if posts|length > 1 else 0 }}</span>
            </h5>

            {% if posts|length > 1 %}
                {% for post in posts[1:] %}
                <div class="post reply-post mb-3 p-3 border rounded">
                    <div class="d-flex">
                        <div class="user-info text-center me-3" style="width: 100px;">
                            <div class="avatar bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                {{ post.author.username[0]|upper if post.author else 'U' }}
                            </div>
                            <div class="user-details">
                                <strong class="d-block" style="font-size: 0.9rem;">{{ post.author.username if post.author else 'Unknown User' }}</strong>
                                <small class="text-muted" style="font-size: 0.8rem;">{{ post.author.profession if post.author and post.author.profession else 'Member' }}</small>
                            </div>
                        </div>
                        <div class="post-content flex-grow-1">
                            <div class="post-meta mb-2">
                                <small class="text-muted">Replied {{ post.created_at|time_ago }}</small>
                            </div>
                            <div class="post-body">
                                {{ post.content|safe }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-comments fa-2x text-muted mb-3"></i>
                    <p class="text-muted">No replies yet. Be the first to reply!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Reply Form -->
    {% if current_user.is_authenticated %}
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Post a Reply</h5>
        </div>
        <div class="card-body">
            <!-- FIXED: This form now posts to the correct reply endpoint -->
            <form method="POST" action="{{ url_for('post_reply', thread_id=thread.id) }}">
                <div class="mb-3">
                    <label for="replyContent" class="form-label">Your Reply</label>
                    <textarea class="form-control" id="replyContent" name="content" rows="5" placeholder="Write your reply here..." required></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Be respectful and constructive in your reply.</small>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> Post Reply
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center">
        <p class="mb-0">Please <a href="{{ url_for('login') }}" class="alert-link">login</a> to post a reply.</p>
    </div>
    {% endif %}
</div>
{% endblock %}